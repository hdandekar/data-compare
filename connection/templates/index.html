{% extends 'app_base.html' %}

{% block title %}
  Dashboard
{% endblock title %}
{% block content %}
  {% load static %}

  <div class="container">
    <div class="row">
      <div class="col col-2">
        <h5>Connection List</h5>
      </div>
      <div class="col col-1">
        <a class="text-success"
           data-bs-title="Add New Connection"
           data-bs-toggle="tooltip"
           data-bs-placement="right"
           hx-get="{% url 'connection:create_connection' %}"
           hx-target="#dialog">
          <i class="fa fa-solid fa-plus fa-xl" aria-hidden="true"></i></a>
      </div>
    </div>
    <table class="table table-striped table-bordered table-sm small"
           aria-label="Connection List">
      {{ connection_count|json_script:"hello-data" }}
      <thead class="thead-dark small">
        <tr>
          {% comment %} <th scope="col">ID</th> {% endcomment %}
          <th scope="col" class="text-center">Connection Name</th>
          <th scope="col" class="text-center">DB Type</th>
          <th scope="col" class="text-center">Host Name</th>
          <th scope="col" class="text-center">Database Name</th>
          <th scope="col" class="text-center">Username</th>
          <th scope="col" class="text-center">Port No</th>
        </tr>
      </thead>
      <tbody hx-trigger="load, connectionListChanged from:body"
             hx-get="{% url 'connection:list' %}"
             hx-target="this"
             class="small">
        <tr class="text-center">
          <td class="spinner-border" role="status">
            <span class="visually-hidden text-center">Loading...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- Placeholder for the modal -->
  <div id="modal" class="modal modal-lg fade">
    <div id="dialog" class="modal-dialog" hx-target="this"></div>
  </div>
{% endblock content %}
{% block inline_javascript %}
  <script type="text/javascript">
    (function() {
      const toastElement = document.getElementById("toast")
      const toastBody = document.getElementById("toast-body")
      const toast = new bootstrap.Toast(toastElement, {
        delay: 5000
      })

      // Change the toast class based on eventType
      htmx.on("showMessage", (e) => {
        console.log("showMessage");
        console.log(e);
        toastBody.innerText = e.detail.value;
        toast.show();
      })


      htmx.on("errors", (e) => {
        console.log("errors are", e)
      })

      // Change the toast class based on eventType
      htmx.on("eventType", (e) => {
        if (['created', 'edited'].includes(e.detail.value)) {
          toastElement.classList.remove('bg-danger', 'bg-success');
          toastElement.classList.add("bg-success");
        } else if (['deleted'].includes(e.detail.value)) {
          toastElement.classList.remove('bg-danger', 'bg-success');
          toastElement.classList.add("bg-danger");
        }
      })
    })();
    (function() {
      const modal = new bootstrap.Modal(document.getElementById("modal"))

      htmx.on("htmx:afterSwap", (e) => {
        console.log("htmx:afterSwap")
        console.log(e)
        // Response targeting #dialog => show the modal
        if (e.detail.target.id == "dialog") {
          modal.show()
        }
      })

      htmx.on("htmx:beforeSwap", (e) => {
        // Empty response targeting #dialog => hide the modal
        console.log("htmx:beforeSwap");
        console.log(e.detail.xhr.response);
        if (e.detail.target.id == "dialog" && !e.detail.xhr.response) {
          modal.hide()
          e.detail.shouldSwap = false
        }
      })

      // Remove dialog content after hiding
      htmx.on("hidden.bs.modal", () => {
        console.log("what am I doing with hidden.bs.modal")
        document.getElementById("dialog").innerHTML = ""
      })
    })();
  </script>
{% endblock inline_javascript %}
